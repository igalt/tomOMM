(function(){
  'use strict';

  var app = angular.module('users');
  app.component('changePasswordComponent', {
    bindings: {},
    templateUrl: 'modules/users/client/views/settings/change-password.client.view.html',
    controller: changePasswordComponent
  });

  changePasswordComponent.$inject = ['$scope', '$http', '$state', '$timeout',
    'Authentication', 'PasswordValidator', 'SendMailService', 'CommonService'];

  function changePasswordComponent($scope, $http, $state, $timeout,
                                    Authentication, PasswordValidator, SendMailService, CommonService) {

    var sendMail = SendMailService.sendMail;
    var logger = CommonService.printToLogger;
    $scope.user = Authentication.user;
    $scope.popoverMsg = PasswordValidator.getPopoverMsg();
    $scope.isGuest = false;

    if (Authentication.user && Authentication.user.roles.indexOf('user') === -1) {
      $scope.passwordDetails = { currentPassword: '' };
      $scope.isGuest = true;
    }

    // Change user password
    $scope.changeUserPassword = function (isValid) {
      $scope.success = $scope.error = null;

      if (!isValid) {
        $scope.$broadcast('show-errors-check-validity', 'passwordForm');
        return false;
      }

      $http.post('/api/users/password', $scope.passwordDetails).success(function (response) {
        // If successful show success message and clear form
        $scope.$broadcast('show-errors-reset', 'passwordForm');
        $scope.success = true;
        $scope.passwordDetails = null;
        if ($scope.isGuest) {
          $timeout(function () {
            // Update user authentication
            $http.get('/api/users/me', $scope.user).success(function (response) {
              // If successful we assign the response to the global user model
              $scope.user = Authentication.user = response;
              sendMailToUser();
              // Do not redirect to the password page
              if ($state.first.state.name !== 'settings.password'){
                $state.go($state.first.state.name , $state.first.params);
              } else {
                // And redirect to the previous state or home page
                $state.go($state.previous.state.name || 'home', $state.previous.params);
              }
            }).error(function (response) {
              $scope.error = response.message;
            });
          }, 2000);
        }
      }).error(function (response) {
        $scope.error = response.message;
      });
    };

    function sendMailToUser() {
      // Prepare the mail details
      // you can send a full email template through 'html' property or
      // an email content that generated by the server
      var mailContent = {
        mailTo: Authentication.user.email,
        subject: 'Welcome to TomMMS',
        name: Authentication.user.displayName,
        content: 'Welcome to TomMMS! ' +
        'Thanks so much for joining us. ' +
        'You are on your way to super-productivity and beyond!'
      };
      // Send the mail
      sendMail(mailContent);
    }
  }
})();
